考虑区间dp

$f[l,r]$ 为区间的答案

观察区间内最后一步：

- 情况1：单个元素，重量增加到 $k$ 之后消除，它与 $l-1,r+1$ 的颜色均不同
  - 直接枚举进行转移，f(l,r)->f(l,i-1)+f(i+1-r)+val[k]-w*(k-m[i])
- 情况2：最后一步消除的是某个被合并过的东西（无论最后一步合并完成时达没达到消除标准），它与 $l-1,r+1$ 的颜色均不同
- 枚举这种颜色，及最后一步合并的位置，那么左右两边要求各选出一个该颜色的子序列且重量之和均不超过k
  - 注意由于 $p_i-p_{i-1}<w$，如果单凭合并就能消除，那么肯定不会加重量，因为亏本

$g[l,r,x]$ 表示：区间 $l\sim r$ 内要选一个同色子序列，重量之和为x<k，且**l一定要被选**，把剩下的都消除了的答案

不要去记 g‘(l,r,d,x) 表示选的颜色是d，会多一维

这样的话，原来的dp转移是f(l,r) -> g'(l,i-1,c[i],p1)+g(i,r,p2)+val[max(k,p1+p2)]（即枚举**第二段**第一个被选的元素i），现在要把g'优化掉

可以改为先枚举**第一段**第一个被选的元素，$h[l,r,p1,p2]$ 为区间l~r，要选出**两个**同色子序列，第一段p1，第二段p2，且l一定被选，把剩余都消掉的答案

这样转移变成了f(l,r)->f(l,i-1)+h(l,r,p1,p2)+val[max(k,p1+p2)]

h的转移再去枚举第二段的第一个元素，h(l,r,p1,p2)->g(l,i-1,p1)+g(i,r,p2)，要求c[l]==c[i]

g的转移是g(l,r,x)->f(l+1,i-1)+g(i,r,x-m[l])（枚举下一个被选的元素）

复杂度貌似是 $O(n^3k^2)$

一定要写记忆化搜索，不然麻烦上天

